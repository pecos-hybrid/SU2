# Continous Integration setup for SU2.
# Tests on the develop branch in both serial and parallel.

dist: xenial
sudo: required

language: python

compiler:
    - gcc

notifications:
    email:
        recipients:
            - clarkp@utexas.edu

branches:
    only:
        - pecos-dev
        - fix-travis-conda

python:
    - 3.6

matrix:
  include:
    - env:
        # Serial build and test
        - CONFIGURE_COMMAND="./preconfigure.py --prefix=$TRAVIS_BUILD_DIR --enable-PY_WRAPPER --disable-tecio"
          TEST_SCRIPT=serial_regression.py
          REGRESSION_TESTS=ON
          PARALLEL=OFF
      addons:
          apt:
              packages:
                - build-essential
                - python3-pip
                - swig
    - env:
        # Parallel build and test
        - CONFIGURE_COMMAND="./preconfigure.py --enable-mpi --with-cc=mpicc --with-cxx=mpicxx --prefix=$TRAVIS_BUILD_DIR --enable-PY_WRAPPER --disable-tecio"
          TEST_SCRIPT=parallel_regression.py
          REGRESSION_TESTS=ON
          PARALLEL=ON
      addons:
          apt:
              packages:
                - build-essential
                - python3-pip
                - swig
                - libopenmpi-dev
    - env:
        # Serial build and unit-test
        - CONFIGURE_COMMAND="./preconfigure.py --prefix=$TRAVIS_BUILD_DIR --with-Boost-include=/usr/include/ --disable-tecio"
          UNIT_TESTS=ON
          PARALLEL=OFF
      addons:
          apt:
              packages:
                - build-essential
                - python3-pip
                - swig
                - libboost-test-dev
    - env:
        # Parallel build and unit-test
        - CONFIGURE_COMMAND="./preconfigure.py --enable-mpi --with-cc=mpicc --with-cxx=mpicxx --prefix=$TRAVIS_BUILD_DIR --with-Boost-include=/usr/include/ --disable-tecio"
          UNIT_TESTS=ON
          PARALLEL=ON
      addons:
          apt:
              packages:
                - build-essential
                - python3-pip
                - swig
                - libopenmpi-dev
                - libboost-test-dev

env:
    global:
        CXXFLAGS="-O1 -Wall -Wextra -Wno-unused-parameter -Wno-empty-body -Wno-format-security"

before_install:
    # Temporarily fixes Travis CI issue with paths for Python packages
    - export PATH=/usr/bin:$PATH
    - sudo pip3 install --upgrade pip
    - sudo pip3 install setuptools
    - sudo pip3 install numpy
    - sudo pip3 install scipy
    - sudo pip3 install wheel
    - if [[ "${PARALLEL}" == "ON" ]]; then
      echo $MPICC &&
      echo $MPICXX &&
      which mpicc &&
      which mpicxx &&
      export MPICC=`which mpicc` &&
      export MPICXX=`which mpicxx` &&
      sudo pip3 install mpi4py;
      fi

    # to avoid interference with MPI
    - test -n $CC  && unset CC
    - test -n $CXX && unset CXX

install:
    # Configure, make, and install SU2
    - echo $TRAVIS_BUILD_DIR
    - echo $CONFIGURE_COMMAND
    - ./bootstrap
    - $CONFIGURE_COMMAND
    - make -j 4
    - make install

    # Add environmental variables according to the configure step
    - export SU2_RUN=$TRAVIS_BUILD_DIR/bin
    - export SU2_HOME=$TRAVIS_BUILD_DIR
    - export PATH=$PATH:$SU2_RUN
    - export PYTHONPATH=$PYTHONPATH:$SU2_RUN

before_script:
    # Get the test cases
    - if [[ "${REGRESSION_TESTS}" == "ON" ]]; then
      git clone -b v6.0.1 https://github.com/su2code/TestCases.git ./TestData &&
      cp -R ./TestData/* ./TestCases/ &&
      cd TestCases/;
      fi

script:
    # Run the tests via the Python scripts
    - if [[ "${REGRESSION_TESTS}" == "ON" ]]; then
      travis_wait 90 python $TEST_SCRIPT;
      fi
    # Run the unit tests
    - if [[ "${UNIT_TESTS}" == "ON" ]]; then
      cd $TRAVIS_BUILD_DIR && make check -j4;
      fi
